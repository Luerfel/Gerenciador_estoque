import tkinter as tk
import customtkinter as ctk
from tkinter import messagebox
import datetime
import oracledb 

class ConcluirVenda:
    def __init__(self, root, valor_total):
        self.root = root
        self.valor_total = valor_total

        self.root.title("Concluir Venda")
        self.root.geometry("400x200")

        self.label_dinheiro = ctk.Label(root, text="Dinheiro:")
        self.label_dinheiro.pack()
        self.entry_dinheiro = ctk.Entry(root)
        self.entry_dinheiro.pack()

        self.label_pix = ctk.Label(root, text="Pix:")
        self.label_pix.pack()
        self.entry_pix = ctk.Entry(root)
        self.entry_pix.pack()

        self.label_credito = ctk.Label(root, text="Crédito:")
        self.label_credito.pack()
        self.entry_credito = ctk.Entry(root)
        self.entry_credito.pack()

        self.label_debito = ctk.Label(root, text="Débito:")
        self.label_debito.pack()
        self.entry_debito = ctk.Entry(root)
        self.entry_debito.pack()

        self.button_finalizar = ctk.Button(root, text="Finalizar Compra", command=self.finalizar_compra)
        self.button_finalizar.pack()

    def finalizar_compra(self):
        dinheiro = float(self.entry_dinheiro.get()) if self.entry_dinheiro.get() else 0
        pix = float(self.entry_pix.get()) if self.entry_pix.get() else 0
        credito = float(self.entry_credito.get()) if self.entry_credito.get() else 0
        debito = float(self.entry_debito.get()) if self.entry_debito.get() else 0

        valor_pago = dinheiro + pix + credito + debito
        troco = valor_pago - self.valor_total

        if troco < 0:
            messagebox.showerror("Erro", "O valor pago é menor que o valor total da compra.")
            return

        # Inserir informações da venda no banco de dados
        data_hora = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        formas_pagamento = ["Dinheiro" if dinheiro else None,
                            "Pix" if pix else None,
                            "Crédito" if credito else None,
                            "Débito" if debito else None]
        formas_pagamento = [forma for forma in formas_pagamento if forma is not None]

        # Inserir informações no banco de dados
        try:
            connection = oracledb.connect(user="usuario", password="senha", host="localhost", port=1521)
            cursor = connection.cursor()

            for forma_pagamento in formas_pagamento:
                cursor.execute("INSERT INTO tbl_vendas (data_hora, forma_pagamento, valor) VALUES (?, ?, ?)",
                               (data_hora, forma_pagamento, self.valor_total))

            connection.commit()
            messagebox.showinfo("Sucesso", "Venda registrada com sucesso.")
        except Exception as e:
            messagebox.showerror("Erro", f"Erro ao registrar venda: {str(e)}")
        finally:
            if 'connection' in locals():
                connection.close()

        self.root.destroy()


def concluir_venda():
    valor_total = 100  # Aqui você substitui pelo valor total da venda
    root = ctk.CTk()
    ConcluirVenda(root, valor_total)
    root.mainloop()


if __name__ == "__main__":
    concluir_venda()
